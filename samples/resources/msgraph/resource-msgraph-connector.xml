<resource xmlns="http://midpoint.evolveum.com/xml/ns/public/common/common-3"
xmlns:c="http://midpoint.evolveum.com/xml/ns/public/common/common-3"
xmlns:icfs="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/resource-schema-3"
 xmlns:org="http://midpoint.evolveum.com/xml/ns/public/common/org-3"
 xmlns:q="http://prism.evolveum.com/xml/ns/public/query-3"
 xmlns:ri="http://midpoint.evolveum.com/xml/ns/public/resource/instance-3"
 xmlns:t="http://prism.evolveum.com/xml/ns/public/types-3"
 oid="9a68292e-9ea7-4b74-8190-f3ae4a9b6926"
 version="6">
    <name>Microsoft Azure AD</name>

    <connectorRef type="ConnectorType">
        <filter>
            <q:and>
                <q:equal>
                    <q:path>c:connectorType</q:path>
                    <q:value>com.evolveum.polygon.connector.msconnector.rest.MSGraphConnector</q:value>
                </q:equal>
            </q:and>
        </filter>
   </connectorRef>
   <connectorConfiguration xmlns:icfc="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/connector-schema-3">
        <icfc:configurationProperties xmlns:gen298="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/bundle/com.evolveum.polygon.connector-microsoft-graph-api/com.evolveum.polygon.connector.msconnector.rest.MSGraphConnector">
            <gen298:clientId>clientId</gen298:clientId>
            <gen298:clientSecret>
                secret
            </gen298:clientSecret>
            <gen298:tenantId>tenantId</gen298:tenantId>
        </icfc:configurationProperties>
    </connectorConfiguration>


      <schemaHandling>

 <objectType>
            <kind>account</kind>
            <intent>default</intent>
            <default>true</default>
            <objectClass>ri:AccountObjectClass</objectClass>
            <attribute>
                <c:ref>icfs:name</c:ref>
                <displayName>Login</displayName>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <c:path>$user/name</c:path>
                    </source>
                    <expression>
                        <script>
                            <language>http://midpoint.evolveum.com/xml/ns/public/expression/language#Groovy</language>
                            <code>
                                name.getOrig() + '@igorfarinicevolveum.onmicrosoft.com';
                            </code>
                        </script>
                    </expression>
                </outbound>
                <inbound>
                    <strength>weak</strength>
                    <source>
                        <c:path>$account/name</c:path>
                    </source>
                    <expression>
                        <script>
                            <language>http://midpoint.evolveum.com/xml/ns/public/expression/language#Groovy</language>
                            <code>
                                name.getOrig().substring(0, name.getOrig().indexOf('@'));
                            </code>
                        </script>
                    </expression>
                    <target>
                        <c:path>$user/name</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:mailNickname</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/extension/mailNickname</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/extension/mailNickname</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:displayName</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/fullName</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/fullName</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:givenName</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/givenName</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/givenName</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:onPremisesImmutableId</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/extension/onPremisesImmutableId</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/extension/onPremisesImmutableId</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:passwordProfile.forceChangePasswordNextSignInWithMfa</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/extension/forceChangePasswordNextSignInWithMfa</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/extension/forceChangePasswordNextSignInWithMfa</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:ageGroup</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/extension/ageGroup</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/extension/ageGroup</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:businessPhones</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/extension/businessPhones</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/extension/businessPhones</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:city</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/extension/city</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/extension/city</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:companyName</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/extension/companyName</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/extension/companyName</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:country</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/extension/country</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/extension/country</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:consentProvidedForMinor</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/extension/consentProvidedForMinor</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/extension/consentProvidedForMinor</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:department</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/extension/department</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/extension/department</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:employeeId</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/employeeNumber</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/employeeNumber</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:faxNumber</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/extension/faxNumber</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/extension/faxNumber</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:jobTitle</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/title</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/title</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:mail</c:ref>
                <inbound>
                    <target>
                        <c:path>$user/extension/mail</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:mobilePhone</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/telephoneNumber</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/telephoneNumber</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:officeLocation</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/locality</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/locality</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:otherMails</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/extension/otherMails</c:path>
                    </source>
                </outbound>

                <inbound>
                    <target>
                        <c:path>$user/extension/otherMails</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:passwordPolicies</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/extension/passwordPolicies</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/extension/passwordPolicies</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:postalCode</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/extension/postalCode</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/extension/postalCode</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:preferredLanguage</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/preferredLanguage</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/preferredLanguage</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:showInAddressList</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/extension/showInAddressList</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/extension/showInAddressList</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:state</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/extension/state</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/extension/state</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:streetAddress</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/extension/streetAddress</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/extension/streetAddress</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:surname</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/familyName</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/familyName</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:usageLocation</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/locale</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/locale</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:userType</c:ref>
                <outbound>
                    <source>
                        <c:path>$user/employeeType</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$user/employeeType</c:path>
                    </target>
                </inbound>
            </attribute>

            <association>
                <c:ref>ri:user_in_groups</c:ref>
                <displayName>User in groups</displayName>
                <kind>entitlement</kind>
                <intent>Group</intent>
                <direction>subjectToObject</direction>
                <associationAttribute>ri:userDirectoryObjectMember</associationAttribute>
                <valueAttribute>icfs:uid</valueAttribute>
                <explicitReferentialIntegrity>false</explicitReferentialIntegrity>
            </association>

            <association>
                <c:ref>ri:user_groups_owner</c:ref>
                <displayName>User groups owner</displayName>
                <kind>entitlement</kind>
                <intent>Group</intent>
                <direction>subjectToObject</direction>
                <associationAttribute>ri:userDirectoryObjectOwner</associationAttribute>
                <valueAttribute>icfs:uid</valueAttribute>
                <explicitReferentialIntegrity>false</explicitReferentialIntegrity>
            </association>

            <protected>
                <filter>
                    <q:equal>
                        <q:matching>http://prism.evolveum.com/xml/ns/public/matching-rule-3#stringIgnoreCase</q:matching>
                        <q:path>attributes/icfs:name</q:path>
                        <q:value>root</q:value>
                    </q:equal>
                </filter>
            </protected>
            <activation>
                <administrativeStatus>
                    <outbound>
                        <strength>strong</strength>
                        <expression>
                            <script xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="c:ScriptExpressionEvaluatorType">
                                <code>
                                    import com.evolveum.midpoint.xml.ns._public.common.common_3.ActivationStatusType;
                                    if (legal) {
                                        input;
                                    } else {
                                        ActivationStatusType.DISABLED;
                                    }
                                </code>
                            </script>
                        </expression>
                    </outbound>
                     <inbound>
                        <strength>weak</strength>
                        <expression>
                            <asIs/>
                        </expression>
                    </inbound>
                </administrativeStatus>
            </activation>
            <credentials>
                <password xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="c:ResourcePasswordDefinitionType">
                    <outbound>
                        <expression>
                            <asIs xsi:type="c:AsIsExpressionEvaluatorType"/>
                        </expression>
                    </outbound>
                </password>
            </credentials>
        </objectType>

        <objectType>
            <kind>entitlement</kind>
            <intent>Group</intent>
            <default>false</default>
            <objectClass>ri:GroupObjectClass</objectClass>
            <attribute>
                <c:ref>icfs:name</c:ref>
                <outbound>
                    <source>
                        <c:path>$focus/name</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$focus/name</c:path>
                    </target>
                </inbound>
                <inbound>
                    <expression>
                        <script xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="c:ScriptExpressionEvaluatorType">
                            <code>
                           return 'group'
                        </code>
                        </script>
                    </expression>
                    <target>
                        <c:path>$focus/subtype</c:path>
                    </target>
                </inbound>
                <inbound>
                    <expression>
                        <script xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="c:ScriptExpressionEvaluatorType">
                            <code>
                           return 'group'
                        </code>
                        </script>
                    </expression>
                    <target>
                        <c:path>$focus/identifier</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:description</c:ref>
                <outbound>
                    <source>
                        <c:path>$focus/description</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$focus/description</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:mailEnabled</c:ref>
                <outbound>
                    <source>
                        <c:path>$focus/extension/mailEnabled</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$focus/extension/mailEnabled</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:mailNickname</c:ref>
                <outbound>
                    <source>
                        <c:path>$focus/extension/mailNickname</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$focus/extension/mailNickname</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:securityEnabled</c:ref>
                <outbound>
                    <source>
                        <c:path>$focus/extension/securityEnabled</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$focus/extension/securityEnabled</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:allowExternalSenders</c:ref>
                <outbound>
                    <source>
                        <c:path>$focus/extension/allowExternalSenders</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$focus/extension/allowExternalSenders</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:autoSubscribeNewMembers</c:ref>
                <outbound>
                    <source>
                        <c:path>$focus/extension/autoSubscribeNewMembers</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$focus/extension/autoSubscribeNewMembers</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:classification</c:ref>
                <outbound>
                    <source>
                        <c:path>$focus/extension/classification</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$focus/extension/classification</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:groupTypes</c:ref>
                <outbound>
                    <source>
                        <c:path>$focus/extension/groupTypes</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$focus/extension/groupTypes</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:isSubscribedByMail</c:ref>
                <outbound>
                    <source>
                        <c:path>$focus/extension/isSubscribedByMail</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$focus/extension/isSubscribedByMail</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:mail</c:ref>
                <outbound>
                    <source>
                        <c:path>$focus/extension/mail</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$focus/extension/mail</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:preferredDataLocation</c:ref>
                <outbound>
                    <source>
                        <c:path>$focus/extension/preferredDataLocation</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$focus/extension/preferredDataLocation</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:proxyAddresses</c:ref>
                <inbound>
                    <target>
                        <c:path>$focus/extension/proxyAddresses</c:path>
                    </target>
                </inbound>
            </attribute>
            <attribute>
                <c:ref>ri:visibility</c:ref>
                <outbound>
                    <source>
                        <c:path>$focus/extension/visibility</c:path>
                    </source>
                </outbound>
                <inbound>
                    <target>
                        <c:path>$focus/extension/visibility</c:path>
                    </target>
                </inbound>
            </attribute>
            <association>
                <c:ref>ri:group_members</c:ref>
                <displayName>Group members</displayName>
                <kind>account</kind>
                <intent>default</intent>
                <direction>subjectToObject</direction>
                <associationAttribute>ri:groupMembers</associationAttribute>
                <valueAttribute>icfs:uid</valueAttribute>
                <explicitReferentialIntegrity>false</explicitReferentialIntegrity>
            </association>

            <association>
                <c:ref>ri:group_owners</c:ref>
                <displayName>Group owners</displayName>
                <kind>account</kind>
                <intent>default</intent>
                <direction>subjectToObject</direction>
                <associationAttribute>ri:groupOwners</associationAttribute>
                <valueAttribute>icfs:uid</valueAttribute>
                <explicitReferentialIntegrity>false</explicitReferentialIntegrity>
            </association>
        </objectType>



</schemaHandling>

 <synchronization>
        <objectSynchronization>
            <name>Users sync</name>
            <kind>account</kind>
            <focusType>c:UserType</focusType>
            <enabled>true</enabled>
            <correlation>
                <q:equal>
                    <q:path>c:name</q:path>
                    <expression>
                        <path>$account/attributes/icfs:name</path>
                    </expression>
                </q:equal>
            </correlation>
            <reconcile>false</reconcile>
            <reaction>
                <situation>linked</situation>
                <synchronize>true</synchronize>
                <reconcile>false</reconcile>
            </reaction>
            <reaction>
                <situation>deleted</situation>
                <synchronize>true</synchronize>
                <reconcile>false</reconcile>
                <action>
                    <handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#deleteShadow</handlerUri>
                </action>
            </reaction>
            <reaction>
                <situation>unlinked</situation>
                <synchronize>true</synchronize>
                <reconcile>false</reconcile>
                <action>
                    <handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#link</handlerUri>
                </action>
            </reaction>
            <reaction>
                <situation>unmatched</situation>
                <synchronize>true</synchronize>
                <reconcile>false</reconcile>
                <action>
                    <handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#addFocus</handlerUri>
                </action>
            </reaction>
        </objectSynchronization>
        <objectSynchronization>
            <name>Groups sync</name>
            <kind>entitlement</kind>
            <intent>Group</intent>
            <focusType>c:OrgType</focusType>
            <enabled>true</enabled>
            <correlation>
                <q:equal>
                    <q:path>c:name</q:path>
                    <expression>
                        <path>$account/attributes/icfs:name</path>
                    </expression>
                </q:equal>
            </correlation>
            <objectTemplateRef oid="99cc8d77-dedc-4444-a081-b006821a9c80"/>
            <reconcile>false</reconcile>
            <reaction>
                <situation>linked</situation>
                <synchronize>true</synchronize>
                <reconcile>false</reconcile>
            </reaction>
            <reaction>
                <situation>deleted</situation>
                <synchronize>true</synchronize>
                <reconcile>false</reconcile>
                <action>
                    <handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#deleteFocus</handlerUri>
                </action>
            </reaction>
            <reaction>
                <situation>unlinked</situation>
                <synchronize>true</synchronize>
                <reconcile>false</reconcile>
                <action>
                    <handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#link</handlerUri>
                </action>
            </reaction>
            <reaction>
                <situation>unmatched</situation>
                <synchronize>true</synchronize>
                <reconcile>false</reconcile>
                <action>
                    <handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#addFocus</handlerUri>
                </action>
            </reaction>
        </objectSynchronization>
</synchronization>

</resource>
